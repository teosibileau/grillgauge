#!/usr/bin/env python3
# Fetch service resource usage stats for GrillGauge dashboard

import subprocess
import sys

def bold(text):
    """Wrap text in ANSI bold escape codes"""
    return f"\033[1m{text}\033[0m"

def get_service_stats(service_name):
    """Get resource usage stats for a systemd service"""
    try:
        # Get PID
        pid_result = subprocess.run(
            ['systemctl', 'show', service_name, '--property=MainPID', '--value'],
            capture_output=True,
            text=True,
            timeout=2
        )
        pid = pid_result.stdout.strip()

        if not pid or pid == '0':
            return None

        # Get process stats
        ps_result = subprocess.run(
            ['ps', '-p', pid, '-o', 'comm,pid,pcpu,pmem,rss,etime', '--no-headers'],
            capture_output=True,
            text=True,
            timeout=2
        )

        if ps_result.returncode != 0:
            return None

        parts = ps_result.stdout.strip().split()
        if len(parts) < 6:
            return None

        # Parse stats
        comm = parts[0]
        pid = parts[1]
        cpu = parts[2]
        mem = parts[3]
        rss_kb = parts[4]
        uptime = parts[5]

        # Convert memory to MB
        mem_mb = float(rss_kb) / 1024

        return {
            'service': service_name,
            'pid': pid,
            'cpu': f"{cpu}%",
            'mem': f"{mem}%",
            'mem_usage': f"{mem_mb:.1f}MB",
            'uptime': uptime
        }
    except Exception as e:
        return None

def main():
    services = ['grillgauge', 'prometheus']

    # Collect stats for all services
    stats = []
    for service in services:
        stat = get_service_stats(service)
        if stat:
            stats.append([
                stat['service'],
                stat['pid'],
                stat['cpu'],
                stat['mem'],
                stat['mem_usage'],
                stat['uptime']
            ])

    if not stats:
        print("No service stats available")
        return

    # Format as table
    try:
        from tabulate import tabulate

        # Add headers with bold
        headers = [
            bold('SERVICE'),
            bold('PID'),
            bold('CPU%'),
            bold('MEM%'),
            bold('MEM USAGE'),
            bold('UPTIME')
        ]

        print(tabulate(stats, headers=headers, tablefmt="simple"))
    except ImportError:
        # Fallback if tabulate not installed
        print(f"{'SERVICE':<15} {'PID':<10} {'CPU%':<8} {'MEM%':<8} {'MEM USAGE':<12} {'UPTIME':<12}")
        for stat in stats:
            print(f"{stat[0]:<15} {stat[1]:<10} {stat[2]:<8} {stat[3]:<8} {stat[4]:<12} {stat[5]:<12}")

if __name__ == "__main__":
    main()
