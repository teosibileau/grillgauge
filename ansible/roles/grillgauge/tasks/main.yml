---
- name: Install python3-venv for virtual environments
  apt:
    name: python3-venv
    state: present
  when: ansible_facts['os_family'] == "Debian"

- name: Create grillgauge directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ ansible_user | default('root') }}"
    group: "{{ ansible_user | default('root') }}"
    mode: '0755'
  loop:
    - /opt/grillgauge

- name: Copy grillgauge source code from control machine
  copy:
    src: "{{ playbook_dir }}/../../src/"
    dest: /opt/grillgauge/src/
    owner: "{{ ansible_user | default('root') }}"
    group: "{{ ansible_user | default('root') }}"
  notify:
    - restart bluetooth-agent
    - restart grillgauge

- name: Copy Python requirements file
  copy:
    src: "{{ playbook_dir }}/../../{{ item }}"
    dest: /opt/grillgauge
    owner: "{{ ansible_user | default('root') }}"
    group: "{{ ansible_user | default('root') }}"
  loop:
    - requirements.txt

- name: Create virtual environment for grillgauge
  command: python3 -m venv /opt/grillgauge/venv
  args:
    creates: /opt/grillgauge/venv
- name: Install grillgauge dependencies in virtual environment
  command: /opt/grillgauge/venv/bin/pip install -r /opt/grillgauge/requirements.txt
  args:
    chdir: /opt/grillgauge

- name: Install bluetooth-agent systemd service
  template:
    src: bluetooth-agent.service.j2
    dest: /etc/systemd/system/bluetooth-agent.service
    mode: '0644'
  when: ansible_facts['os_family'] == "Debian"
  notify: restart bluetooth-agent

- name: Enable and start bluetooth-agent service
  systemd:
    name: bluetooth-agent
    enabled: yes
    state: started
    daemon_reload: yes
  when: ansible_facts['os_family'] == "Debian"

- name: Check bluetooth-agent service status
  command: systemctl status bluetooth-agent --no-pager
  register: bluetooth_agent_status
  changed_when: false
  failed_when: false
  when: ansible_facts['os_family'] == "Debian"

- name: Display bluetooth-agent service status
  debug:
    msg: "{{ bluetooth_agent_status.stdout_lines }}"
  when:
    - ansible_facts['os_family'] == "Debian"
    - bluetooth_agent_status.stdout_lines is defined

- name: Create .env file
  template:
    src: grillgauge.env.j2
    dest: /opt/grillgauge/.env
    owner: "{{ ansible_user | default('root') }}"
    group: "{{ ansible_user | default('root') }}"
    mode: '0600'

# Cleanup old scan timer/service (consolidated into main service)
- name: Stop old grillgauge-scan timer (if exists)
  systemd:
    name: grillgauge-scan.timer
    state: stopped
    enabled: no
  ignore_errors: yes
  when: ansible_facts['os_family'] == "Debian"

- name: Remove old grillgauge-scan timer unit file
  file:
    path: /etc/systemd/system/grillgauge-scan.timer
    state: absent
  when: ansible_facts['os_family'] == "Debian"

- name: Remove old grillgauge-scan service unit file
  file:
    path: /etc/systemd/system/grillgauge-scan.service
    state: absent
  when: ansible_facts['os_family'] == "Debian"

- name: Reload systemd daemon after cleanup
  systemd:
    daemon_reload: yes
  when: ansible_facts['os_family'] == "Debian"

- name: Install systemd service
  template:
    src: grillgauge.service.j2
    dest: /etc/systemd/system/grillgauge.service
  notify: restart grillgauge

- name: Cleanup temporary files
  file:
    path: /tmp/grillgauge
    state: absent
  ignore_errors: true
